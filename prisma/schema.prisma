generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  GOOGLE
}

enum UserRole {
  ADMIN
  USER
}

enum ConnectedPlatform {
  TWITCH
  KICK
  YOUTUBE
  INSTAGRAM
  TIKTOK
}

enum GiveawayStatus {
  DRAFT
  OPEN
  CLOSED
}

enum DonationWindow {
  DAILY
  WEEKLY
  MONTHLY
}

model User {
  id                      String                      @id @default(uuid())
  email                   String                      @unique
  displayName             String
  avatarUrl               String?
  provider                AuthProvider
  providerId              String
  role                    UserRole                    @default(USER)
  createdAt               DateTime                    @default(now())
  updatedAt               DateTime                    @updatedAt
  accounts                ConnectedAccount[]
  ticketGlobalRules       TicketGlobalRule[]
  ticketGlobalDonationRules TicketGlobalDonationRule[]
  giveaways               Giveaway[]

  @@unique([provider, providerId])
}

model ConnectedAccount {
  id                String             @id @default(uuid())
  userId            String
  platform          ConnectedPlatform
  externalChannelId String
  displayName       String
  accessToken       String
  refreshToken      String?
  scopes            String?
  expiresAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([platform, externalChannelId])
}

// Global ticket rules - base status roles for all giveaways
// These rules define how many tickets each user role/tier receives based on their subscription status
// Roles represent the "base state" of the user: non-sub, twitch tier, kick sub, youtube sub
// NON_SUB must be platform-specific (e.g., NON_SUB for Twitch, NON_SUB for Kick)
// Gift subs are handled in TicketGlobalDonationRule, not here
model TicketGlobalRule {
  id             String             @id @default(uuid())
  userId         String
  platform       ConnectedPlatform  // Platform is required, especially for NON_SUB
  role           String             // "NON_SUB", "TWITCH_TIER_1", "TWITCH_TIER_2", "TWITCH_TIER_3", "KICK_SUB", "YOUTUBE_SUB"
  ticketsPerUnit Int
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, platform, role])
}

// Global donation rules - extra ticket increments based on donations/gifts
// These rules define ticket bonuses based on quantity of bits/coins/gifts
// Time window (daily/weekly/monthly) is not defined here; it will be set per giveaway
// Examples:
//   - Bits: unitType="BITS", unitSize=100, ticketsPerUnitSize=1 → 100 bits = 1 ticket
//   - Gift subs: unitType="GIFT_SUB", unitSize=1, ticketsPerUnitSize=4 → 1 gift = 4 tickets
model TicketGlobalDonationRule {
  id                 String             @id @default(uuid())
  userId             String
  platform           ConnectedPlatform  // TWITCH, KICK, YOUTUBE…
  unitType           String             // "BITS", "GIFT_SUB", "KICK_COINS", etc.
  unitSize           Int                // size of the "block" of units (e.g., 100 bits, 1 gift)
  ticketsPerUnitSize Int                // tickets per block (e.g., 1 ticket per 100 bits, 4 tickets per gift)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, unitType])
}

model Giveaway {
  id        String          @id @default(uuid())
  userId    String
  name      String
  description String?
  status    GiveawayStatus
  platforms Json            // Array<ConnectedPlatform> (TWITCH/KICK/YOUTUBE)
  keyword   String          // OBRIGATÓRIA (STREAMS)

  // filtros de elegibilidade (wizard step 2)
  allowedRoles Json         // Array<string> das roles permitidas (ex.: ["NON_SUB","TWITCH_TIER_1",...])

  // doações por sorteio (wizard step 4)
  includeBitsDonors      Boolean        @default(false)
  includeGiftSubDonors   Boolean        @default(false)
  includeCoinsDonors     Boolean        @default(false) // ex.: KICK_COINS
  includeSuperchatDonors Boolean        @default(false)
  bitsDonationWindow     DonationWindow?
  giftSubDonationWindow  DonationWindow?
  coinsDonationWindow    DonationWindow?
  superchatDonationWindow DonationWindow?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user                 User                           @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketRuleOverrides  GiveawayTicketRuleOverride[]
  donationRuleOverrides GiveawayDonationRuleOverride[]
  participants         GiveawayParticipant[]

  @@index([userId, status])
}

model GiveawayTicketRuleOverride {
  id             String   @id @default(uuid())
  giveawayId     String
  role           String   // mesma semântica do TicketGlobalRule.role
  ticketsPerUnit Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  giveaway       Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)
  @@unique([giveawayId, role])
}

model GiveawayDonationRuleOverride {
  id                 String            @id @default(uuid())
  giveawayId         String
  platform           ConnectedPlatform
  unitType           String            // "BITS" | "GIFT_SUB" | "KICK_COINS" | "SUPERCHAT"
  unitSize           Int
  ticketsPerUnitSize Int
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  giveaway           Giveaway          @relation(fields: [giveawayId], references: [id], onDelete: Cascade)
  @@unique([giveawayId, platform, unitType])
}

model GiveawayParticipant {
  id             String             @id @default(uuid())
  giveawayId     String
  platform       ConnectedPlatform
  externalUserId String
  username       String
  isSub          Boolean
  subTier        Int?
  donationAmount Int?               // total de "unidades" (ex.: bits) considerados pra esse sorteio (se aplicável)
  tickets        Int
  sourceDetails  Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  giveaway       Giveaway          @relation(fields: [giveawayId], references: [id], onDelete: Cascade)
  @@index([giveawayId])
  @@index([giveawayId, platform, externalUserId])
}
