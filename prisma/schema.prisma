generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  GOOGLE
}

enum UserRole {
  ADMIN
  USER
}

enum ConnectedPlatform {
  TWITCH
  KICK
  YOUTUBE
  INSTAGRAM
  TIKTOK
}

enum StreamGiveawayStatus {
  DRAFT
  OPEN
  DONE
  CLOSED
}

enum DonationWindow {
  DAILY
  WEEKLY
  MONTHLY
}

enum EntryMethod {
  BITS
  GIFT_SUB
  KICK_COINS
  SUPERCHAT
  TWITCH_TIER_1
  TWITCH_TIER_2
  TWITCH_TIER_3
  TWITCH_NON_SUB
  KICK_SUB
  KICK_NON_SUB
  YOUTUBE_SUB
  YOUTUBE_NON_SUB
}

enum WinnerStatus {
  WINNER
  REPICK
}

enum KickGiftSubsCategory {
  WEEKLY
  MONTHLY
}

enum KickCoinsCategory {
  WEEKLY
  MONTHLY
}

enum TwitchBitsCategory {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum TwitchGiftSubsCategory {
  ACTIVE
}

enum IntegratedBitsKickCoinsCategory {
  WEEKLY
  MONTHLY
}

enum IntegratedGiftSubsCategory {
  ACTIVE
}

enum EventType {
  BITS
  SUBSCRIPTION      // Novo sub ou renovação
  GIFT_SUBSCRIPTION // Presente de sub
  KICK_COINS        // Kick coins gifted
}

model User {
  id                        String                     @id @default(uuid())
  email                     String                     @unique
  displayName               String
  avatarUrl                 String?
  provider                  AuthProvider
  providerId                String
  role                      UserRole                   @default(USER)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  accounts                  ConnectedAccount[]
  ticketGlobalRules         TicketGlobalRule[]
  ticketGlobalDonationRules TicketGlobalDonationRule[]
  streamGiveaways           StreamGiveaway[]
  kickGiftSubsGiveaways     KickGiftSubsGiveaway[]
  kickCoinsGiveaways              KickCoinsGiveaway[]
  twitchBitsGiveaways             TwitchBitsGiveaway[]
  twitchGiftSubsGiveaways         TwitchGiftSubsGiveaway[]
  integratedBitsKickCoinsGiveaways IntegratedBitsKickCoinsGiveaway[]
  integratedGiftSubsGiveaways     IntegratedGiftSubsGiveaway[]

  @@unique([provider, providerId])
}

model ConnectedAccount {
  id                String            @id @default(uuid())
  userId            String
  platform          ConnectedPlatform
  externalChannelId String
  displayName       String
  accessToken       String
  refreshToken      String?
  scopes            String?
  expiresAt         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, externalChannelId])
}

// Global ticket rules - base status roles for all stream giveaways
// These rules define how many tickets each user role/tier receives based on their subscription status
// Roles represent the "base state" of the user: non-sub, twitch tier, kick sub, youtube sub
// NON_SUB must be platform-specific (e.g., NON_SUB for Twitch, NON_SUB for Kick)
// Gift subs are handled in TicketGlobalDonationRule, not here
model TicketGlobalRule {
  id             String            @id @default(uuid())
  userId         String
  platform       ConnectedPlatform // Platform is required, especially for NON_SUB
  role           String // "NON_SUB", "TWITCH_TIER_1", "TWITCH_TIER_2", "TWITCH_TIER_3", "KICK_SUB", "YOUTUBE_SUB"
  ticketsPerUnit Int
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, role])
}

// Global donation rules - extra ticket increments based on donations/gifts
// These rules define ticket bonuses based on quantity of bits/coins/gifts
// Time window (daily/weekly/monthly) is not defined here; it will be set per stream giveaway
// Examples:
//   - Bits: unitType="BITS", unitSize=100, ticketsPerUnitSize=1 → 100 bits = 1 ticket
//   - Gift subs: unitType="GIFT_SUB", unitSize=1, ticketsPerUnitSize=4 → 1 gift = 4 tickets
model TicketGlobalDonationRule {
  id                 String            @id @default(uuid())
  userId             String
  platform           ConnectedPlatform // TWITCH, KICK, YOUTUBE…
  unitType           String // "BITS", "GIFT_SUB", "KICK_COINS", etc.
  unitSize           Int // size of the "block" of units (e.g., 100 bits, 1 gift)
  ticketsPerUnitSize Int // tickets per block (e.g., 1 ticket per 100 bits, 4 tickets per gift)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, unitType])
}

model StreamGiveaway {
  id          String               @id @default(uuid())
  userId      String
  name        String
  description String?
  status      StreamGiveawayStatus
  platforms   Json // Array<ConnectedPlatform> (TWITCH/KICK/YOUTUBE)
  keyword     String // OBRIGATÓRIA (STREAMS)

  // filtros de elegibilidade (wizard step 2)
  allowedRoles Json // Array<string> das roles permitidas (ex.: ["NON_SUB","TWITCH_TIER_1",...])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                  User                                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketRuleOverrides   StreamGiveawayTicketRuleOverride[]
  donationRuleOverrides StreamGiveawayDonationRuleOverride[]
  donationConfigs       StreamGiveawayDonationConfig[]
  participants          StreamGiveawayParticipant[]
  winners               StreamGiveawayWinner[]

  @@index([userId, status])
}

model StreamGiveawayTicketRuleOverride {
  id               String         @id @default(uuid())
  streamGiveawayId String
  role             String // mesma semântica do TicketGlobalRule.role
  ticketsPerUnit   Int
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  streamGiveaway   StreamGiveaway @relation(fields: [streamGiveawayId], references: [id], onDelete: Cascade)

  @@unique([streamGiveawayId, role])
}

model StreamGiveawayDonationRuleOverride {
  id                 String            @id @default(uuid())
  streamGiveawayId   String
  platform           ConnectedPlatform
  unitType           String // "BITS" | "GIFT_SUB" | "KICK_COINS" | "SUPERCHAT"
  unitSize           Int
  ticketsPerUnitSize Int
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  streamGiveaway     StreamGiveaway    @relation(fields: [streamGiveawayId], references: [id], onDelete: Cascade)

  @@unique([streamGiveawayId, platform, unitType])
}

// Configuração de doações por stream giveaway (tabela pivô)
// Define quais tipos de doação estão habilitados e suas janelas de tempo
model StreamGiveawayDonationConfig {
  id               String            @id @default(uuid())
  streamGiveawayId String
  platform         ConnectedPlatform // TWITCH, KICK, YOUTUBE
  unitType         String // "BITS" | "GIFT_SUB" | "KICK_COINS" | "SUPERCHAT"
  donationWindow   DonationWindow // DAILY | WEEKLY | MONTHLY
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  streamGiveaway   StreamGiveaway    @relation(fields: [streamGiveawayId], references: [id], onDelete: Cascade)

  @@unique([streamGiveawayId, platform, unitType])
}

model StreamGiveawayParticipant {
  id               String                 @id @default(uuid())
  streamGiveawayId String
  platform         ConnectedPlatform
  externalUserId   String
  username         String
  avatarUrl        String? // URL da foto/avatar do participante
  method           EntryMethod // Método de entrada: BITS, TIER_1, NON_SUB, etc.
  tickets          Int // Quantidade de tickets para esta entrada específica
  metadata         Json? // Dados adicionais opcionais (ex.: quantidade de bits, tier específico, etc.)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  streamGiveaway   StreamGiveaway         @relation(fields: [streamGiveawayId], references: [id], onDelete: Cascade)
  winnerIn         StreamGiveawayWinner[] @relation("WinnerParticipant")

  @@index([streamGiveawayId])
  @@index([streamGiveawayId, platform, externalUserId])
  @@index([streamGiveawayId, externalUserId, method]) // Permite múltiplas entradas do mesmo usuário com métodos diferentes
}

model StreamGiveawayWinner {
  id                       String                    @id @default(uuid())
  streamGiveawayId         String
  winnerParticipantId      String // ID do participante vencedor
  status                   WinnerStatus // WINNER ou REPICK
  participantRanges        Json // Array de ranges: [{id, display, start, end}]
  totalTickets             Int // Total de tickets no sorteio
  listHashAlgo             String // SHA256 ou MD5
  listHash                 String // Hash da lista de participantes
  randomOrgRandom          Json // Payload completo do Random.org (result.random)
  randomOrgSignature       String // Assinatura do Random.org
  randomOrgVerificationUrl String // URL para verificar a assinatura
  drawnNumber              Int // Número sorteado
  verified                 Boolean // Se a assinatura foi verificada
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  streamGiveaway           StreamGiveaway            @relation(fields: [streamGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant        StreamGiveawayParticipant @relation("WinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([streamGiveawayId])
  @@index([streamGiveawayId, status])
  @@index([winnerParticipantId])
}

// Kick Gift Subs Giveaways - sorteios baseados em gift subs da Kick
model KickGiftSubsGiveaway {
  id        String               @id @default(uuid())
  userId    String
  name      String
  category  KickGiftSubsCategory // WEEKLY ou MONTHLY
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  user         User                              @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants KickGiftSubsGiveawayParticipant[]
  winners      KickGiftSubsGiveawayWinner[]

  @@index([userId])
}

model KickGiftSubsGiveawayParticipant {
  id                     String   @id @default(uuid())
  kickGiftSubsGiveawayId String
  externalUserId         String // user_id da API da Kick
  username               String
  avatarUrl              String? // URL da foto/avatar do participante
  quantity               Int // Quantidade de gift subs
  tickets                Int // Quantidade de tickets calculados
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  kickGiftSubsGiveaway KickGiftSubsGiveaway         @relation(fields: [kickGiftSubsGiveawayId], references: [id], onDelete: Cascade)
  winnerIn             KickGiftSubsGiveawayWinner[] @relation("KickGiftSubsWinnerParticipant")

  @@index([kickGiftSubsGiveawayId])
  @@index([kickGiftSubsGiveawayId, externalUserId])
}

model KickGiftSubsGiveawayWinner {
  id                       String       @id @default(uuid())
  kickGiftSubsGiveawayId   String
  winnerParticipantId      String // ID do participante vencedor
  status                   WinnerStatus // WINNER ou REPICK
  participantRanges        Json // Array de ranges: [{id, display, start, end}]
  totalTickets             Int // Total de tickets no sorteio
  listHashAlgo             String // SHA256 ou MD5
  listHash                 String // Hash da lista de participantes
  randomOrgRandom          Json // Payload completo do Random.org (result.random)
  randomOrgSignature       String // Assinatura do Random.org
  randomOrgVerificationUrl String // URL para verificar a assinatura
  drawnNumber              Int // Número sorteado
  verified                 Boolean // Se a assinatura foi verificada
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt

  kickGiftSubsGiveaway KickGiftSubsGiveaway            @relation(fields: [kickGiftSubsGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant    KickGiftSubsGiveawayParticipant @relation("KickGiftSubsWinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([kickGiftSubsGiveawayId])
  @@index([kickGiftSubsGiveawayId, status])
  @@index([winnerParticipantId])
}

// Kick Coins Giveaways - sorteios baseados em kick coins da Kick
model KickCoinsGiveaway {
  id        String              @id @default(uuid())
  userId    String
  name      String
  category  KickCoinsCategory // WEEKLY ou MONTHLY
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  user         User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants KickCoinsGiveawayParticipant[]
  winners      KickCoinsGiveawayWinner[]

  @@index([userId])
}

model KickCoinsGiveawayParticipant {
  id                  String   @id @default(uuid())
  kickCoinsGiveawayId String
  externalUserId      String // user_id da API da Kick
  username            String
  avatarUrl           String? // URL da foto/avatar do participante
  giftedAmount        Int // Quantidade de kick coins (gifted_amount)
  tickets             Int // Quantidade de tickets calculados
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  kickCoinsGiveaway KickCoinsGiveaway         @relation(fields: [kickCoinsGiveawayId], references: [id], onDelete: Cascade)
  winnerIn          KickCoinsGiveawayWinner[] @relation("KickCoinsWinnerParticipant")

  @@index([kickCoinsGiveawayId])
  @@index([kickCoinsGiveawayId, externalUserId])
}

model KickCoinsGiveawayWinner {
  id                     String                  @id @default(uuid())
  kickCoinsGiveawayId     String
  winnerParticipantId     String // ID do participante vencedor
  status                  WinnerStatus // WINNER ou REPICK
  participantRanges       Json // Array de ranges: [{id, display, start, end}]
  totalTickets            Int // Total de tickets no sorteio
  listHashAlgo            String // SHA256 ou MD5
  listHash                String // Hash da lista de participantes
  randomOrgRandom         Json // Payload completo do Random.org (result.random)
  randomOrgSignature      String // Assinatura do Random.org
  randomOrgVerificationUrl String // URL para verificar a assinatura
  drawnNumber             Int // Número sorteado
  verified                Boolean // Se a assinatura foi verificada
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt

  kickCoinsGiveaway KickCoinsGiveaway            @relation(fields: [kickCoinsGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant  KickCoinsGiveawayParticipant @relation("KickCoinsWinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([kickCoinsGiveawayId])
  @@index([kickCoinsGiveawayId, status])
  @@index([winnerParticipantId])
}

// Twitch Bits Giveaways - sorteios baseados em bits da Twitch
model TwitchBitsGiveaway {
  id        String              @id @default(uuid())
  userId    String
  name      String
  category  TwitchBitsCategory // WEEKLY, MONTHLY ou CUSTOM
  startDate DateTime? // Data de início (obrigatório se CUSTOM)
  endDate   DateTime? // Data de fim (obrigatório se CUSTOM)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  user         User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants TwitchBitsGiveawayParticipant[]
  winners      TwitchBitsGiveawayWinner[]

  @@index([userId])
}

model TwitchBitsGiveawayParticipant {
  id                  String   @id @default(uuid())
  twitchBitsGiveawayId String
  externalUserId      String // user_id da API da Twitch
  username            String
  avatarUrl           String? // URL da foto/avatar do participante
  score               Int // Quantidade de bits (score)
  tickets             Int // Quantidade de tickets calculados
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  twitchBitsGiveaway TwitchBitsGiveaway         @relation(fields: [twitchBitsGiveawayId], references: [id], onDelete: Cascade)
  winnerIn           TwitchBitsGiveawayWinner[] @relation("TwitchBitsWinnerParticipant")

  @@index([twitchBitsGiveawayId])
  @@index([twitchBitsGiveawayId, externalUserId])
}

model TwitchBitsGiveawayWinner {
  id                     String                  @id @default(uuid())
  twitchBitsGiveawayId   String
  winnerParticipantId    String // ID do participante vencedor
  status                 WinnerStatus // WINNER ou REPICK
  participantRanges      Json // Array de ranges: [{id, display, start, end}]
  totalTickets           Int // Total de tickets no sorteio
  listHashAlgo           String // SHA256 ou MD5
  listHash               String // Hash da lista de participantes
  randomOrgRandom        Json // Payload completo do Random.org (result.random)
  randomOrgSignature     String // Assinatura do Random.org
  randomOrgVerificationUrl String // URL para verificar a assinatura
  drawnNumber            Int // Número sorteado
  verified               Boolean // Se a assinatura foi verificada
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  twitchBitsGiveaway TwitchBitsGiveaway            @relation(fields: [twitchBitsGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant  TwitchBitsGiveawayParticipant @relation("TwitchBitsWinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([twitchBitsGiveawayId])
  @@index([twitchBitsGiveawayId, status])
  @@index([winnerParticipantId])
}

// Twitch Gift Subs Giveaways - sorteios baseados em gift subs da Twitch
model TwitchGiftSubsGiveaway {
  id        String                    @id @default(uuid())
  userId    String
  name      String
  category  TwitchGiftSubsCategory // ACTIVE
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt

  user         User                                @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants TwitchGiftSubsGiveawayParticipant[]
  winners      TwitchGiftSubsGiveawayWinner[]

  @@index([userId])
}

model TwitchGiftSubsGiveawayParticipant {
  id                        String   @id @default(uuid())
  twitchGiftSubsGiveawayId  String
  externalUserId            String // gifter_id da API da Twitch
  username                  String // gifter_name da API da Twitch
  avatarUrl                 String? // URL da foto/avatar do participante
  quantity                  Int // Quantidade de gift subs
  tickets                   Int // Quantidade de tickets calculados
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  twitchGiftSubsGiveaway TwitchGiftSubsGiveaway         @relation(fields: [twitchGiftSubsGiveawayId], references: [id], onDelete: Cascade)
  winnerIn               TwitchGiftSubsGiveawayWinner[] @relation("TwitchGiftSubsWinnerParticipant")

  @@index([twitchGiftSubsGiveawayId])
  @@index([twitchGiftSubsGiveawayId, externalUserId])
}

model TwitchGiftSubsGiveawayWinner {
  id                         String       @id @default(uuid())
  twitchGiftSubsGiveawayId   String
  winnerParticipantId        String // ID do participante vencedor
  status                     WinnerStatus // WINNER ou REPICK
  participantRanges          Json // Array de ranges: [{id, display, start, end}]
  totalTickets               Int // Total de tickets no sorteio
  listHashAlgo               String // SHA256 ou MD5
  listHash                   String // Hash da lista de participantes
  randomOrgRandom            Json // Payload completo do Random.org (result.random)
  randomOrgSignature         String // Assinatura do Random.org
  randomOrgVerificationUrl   String // URL para verificar a assinatura
  drawnNumber                Int // Número sorteado
  verified                   Boolean // Se a assinatura foi verificada
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @updatedAt

  twitchGiftSubsGiveaway TwitchGiftSubsGiveaway            @relation(fields: [twitchGiftSubsGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant      TwitchGiftSubsGiveawayParticipant @relation("TwitchGiftSubsWinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([twitchGiftSubsGiveawayId])
  @@index([twitchGiftSubsGiveawayId, status])
  @@index([winnerParticipantId])
}

// Integrated Bits + Kick Coins Giveaways - sorteios integrados de Twitch Bits e Kick Coins
model IntegratedBitsKickCoinsGiveaway {
  id        String                             @id @default(uuid())
  userId    String
  name      String
  category  IntegratedBitsKickCoinsCategory    // WEEKLY ou MONTHLY
  createdAt DateTime                           @default(now())
  updatedAt DateTime                           @updatedAt

  user         User                                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants IntegratedBitsKickCoinsGiveawayParticipant[]
  winners      IntegratedBitsKickCoinsGiveawayWinner[]

  @@index([userId])
}

model IntegratedBitsKickCoinsGiveawayParticipant {
  id                                String            @id @default(uuid())
  integratedBitsKickCoinsGiveawayId String
  platform                          ConnectedPlatform // TWITCH ou KICK
  externalUserId                    String            // user_id da API da Twitch ou Kick
  username                          String
  avatarUrl                         String?           // URL da foto/avatar do participante
  amount                            Int               // Quantidade de bits (Twitch) ou kick coins (Kick)
  tickets                           Int               // Quantidade de tickets calculados
  createdAt                         DateTime          @default(now())
  updatedAt                         DateTime          @updatedAt

  integratedBitsKickCoinsGiveaway IntegratedBitsKickCoinsGiveaway         @relation(fields: [integratedBitsKickCoinsGiveawayId], references: [id], onDelete: Cascade)
  winnerIn                        IntegratedBitsKickCoinsGiveawayWinner[] @relation("IntegratedBitsKickCoinsWinnerParticipant")

  @@index([integratedBitsKickCoinsGiveawayId], map: "integrated_bits_kick_participant_giveaway_id_idx")
  @@index([integratedBitsKickCoinsGiveawayId, platform, externalUserId], map: "integrated_bits_kick_participant_platform_user_idx")
}

model IntegratedBitsKickCoinsGiveawayWinner {
  id                                 String                  @id @default(uuid())
  integratedBitsKickCoinsGiveawayId  String
  winnerParticipantId                String                  // ID do participante vencedor
  status                             WinnerStatus            // WINNER ou REPICK
  participantRanges                  Json                    // Array de ranges: [{id, display, start, end}]
  totalTickets                       Int                     // Total de tickets no sorteio
  listHashAlgo                       String                  // SHA256 ou MD5
  listHash                           String                  // Hash da lista de participantes
  randomOrgRandom                    Json                    // Payload completo do Random.org (result.random)
  randomOrgSignature                 String                  // Assinatura do Random.org
  randomOrgVerificationUrl           String                  // URL para verificar a assinatura
  drawnNumber                        Int                     // Número sorteado
  verified                           Boolean                 // Se a assinatura foi verificada
  createdAt                          DateTime                @default(now())
  updatedAt                          DateTime                @updatedAt

  integratedBitsKickCoinsGiveaway IntegratedBitsKickCoinsGiveaway            @relation(fields: [integratedBitsKickCoinsGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant               IntegratedBitsKickCoinsGiveawayParticipant @relation("IntegratedBitsKickCoinsWinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([integratedBitsKickCoinsGiveawayId], map: "integrated_bits_kick_winner_giveaway_id_idx")
  @@index([integratedBitsKickCoinsGiveawayId, status], map: "integrated_bits_kick_winner_giveaway_id_status_idx")
  @@index([winnerParticipantId], map: "integrated_bits_kick_winner_participant_id_idx")
}

// Integrated Gift Subs Giveaways - sorteios integrados de Twitch Gift Subs e Kick Gift Subs
model IntegratedGiftSubsGiveaway {
  id        String                        @id @default(uuid())
  userId    String
  name      String
  category  IntegratedGiftSubsCategory    // ACTIVE
  createdAt DateTime                      @default(now())
  updatedAt DateTime                      @updatedAt

  user         User                                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants IntegratedGiftSubsGiveawayParticipant[]
  winners      IntegratedGiftSubsGiveawayWinner[]

  @@index([userId])
}

model IntegratedGiftSubsGiveawayParticipant {
  id                           String            @id @default(uuid())
  integratedGiftSubsGiveawayId String
  platform                     ConnectedPlatform // TWITCH ou KICK
  externalUserId               String            // gifter_id (Twitch) ou user_id (Kick)
  username                     String
  avatarUrl                    String?           // URL da foto/avatar do participante
  quantity                     Int               // Quantidade de gift subs
  tickets                      Int               // Quantidade de tickets calculados
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @updatedAt

  integratedGiftSubsGiveaway IntegratedGiftSubsGiveaway         @relation(fields: [integratedGiftSubsGiveawayId], references: [id], onDelete: Cascade)
  winnerIn                   IntegratedGiftSubsGiveawayWinner[] @relation("IntegratedGiftSubsWinnerParticipant")

  @@index([integratedGiftSubsGiveawayId], map: "integrated_gift_subs_participant_giveaway_id_idx")
  @@index([integratedGiftSubsGiveawayId, platform, externalUserId], map: "integrated_gift_subs_participant_platform_user_idx")
}

model IntegratedGiftSubsGiveawayWinner {
  id                            String       @id @default(uuid())
  integratedGiftSubsGiveawayId  String
  winnerParticipantId           String       // ID do participante vencedor
  status                        WinnerStatus // WINNER ou REPICK
  participantRanges             Json         // Array de ranges: [{id, display, start, end}]
  totalTickets                  Int          // Total de tickets no sorteio
  listHashAlgo                  String       // SHA256 ou MD5
  listHash                      String       // Hash da lista de participantes
  randomOrgRandom               Json         // Payload completo do Random.org (result.random)
  randomOrgSignature            String       // Assinatura do Random.org
  randomOrgVerificationUrl      String       // URL para verificar a assinatura
  drawnNumber                   Int          // Número sorteado
  verified                      Boolean      // Se a assinatura foi verificada
  createdAt                     DateTime     @default(now())
  updatedAt                     DateTime     @updatedAt

  integratedGiftSubsGiveaway IntegratedGiftSubsGiveaway            @relation(fields: [integratedGiftSubsGiveawayId], references: [id], onDelete: Cascade)
  winnerParticipant          IntegratedGiftSubsGiveawayParticipant @relation("IntegratedGiftSubsWinnerParticipant", fields: [winnerParticipantId], references: [id], onDelete: Cascade)

  @@index([integratedGiftSubsGiveawayId], map: "integrated_gift_subs_winner_giveaway_id_idx")
  @@index([integratedGiftSubsGiveawayId, status], map: "integrated_gift_subs_winner_giveaway_id_status_idx")
  @@index([winnerParticipantId], map: "integrated_gift_subs_winner_participant_id_idx")
}

// Event table - Registra eventos de bits em tempo real
model Event {
  id              String            @id @default(uuid())
  userId          String            // ID do usuário dono do canal
  platform        ConnectedPlatform // TWITCH
  eventType       EventType         // BITS
  externalUserId  String            // ID do usuário que doou
  username        String            // Username do doador
  amount          Int               // Quantidade de bits
  message         String?           // Mensagem enviada junto com os bits
  metadata        Json?             // Dados extras do evento
  eventDate       DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([userId, platform])
  @@index([userId, platform, eventType, eventDate])
}
